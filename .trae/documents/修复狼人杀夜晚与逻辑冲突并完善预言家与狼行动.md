## 核心问题概述
- 夜晚与白天阶段显示冲突：组件 `PhaseIndicator` 的阶段常量与服务端状态不一致，导致“天亮”与“正常环节”错位。
- 预言家查验结果未实现私有反馈与前端身份卡展示：服务端仅写入 `gameLog`，未私发结果给预言家；前端未派生 `seerCheckHistory`。
- 狼人在晚上未选择刀人：未统一最终目标、且在超时后缺少默认行为。
- 女巫中断处理的顺序与规则需要确保阻塞式结算（守卫/解药/奶穿/毒药优先级）。

## 服务端改动
- GameStateMachine（`src/server/GameStateMachine.ts`）
  - 阶段时序：保留 `NIGHT → DAY_MORNING_RESULT → DAY_DISCUSS → DAY_VOTE`，在 `onTimerEnd` 严格切换（已实现，参见 137-177）。
  - 夜间结算：在 `resolveNightActions`（495-611）维持优先级；修复事项：
    - 在 `resolveWerewolfVoting`（759-796）加入平票随机与无投票时的默认目标（随机存活非狼玩家）。
    - 在 `resolveNightActions` 生成 `checkResults`（520-529）后，向预言家“私聊”结果：`io.to(seer.socketId).emit('seer_check_result', { targetId, result, round })`；仅在玩家为预言家且 `socketId` 存在时触发。
    - 对 AI 预言家：插入私有记忆流，新增接口例如 `agent.addPrivateHint("Player X is Werewolf")`，在 `checkResults` 生成后调用（在 520-529 之后）。
  - 说话/发言：保留 `speaker_change` 与 `speech_timeout`（217-262）；不改动。

- RoomManager（`src/server/RoomManager.ts`）
  - 角色可见性与日志：在 `broadcastRoomState`（221-259）生成 `playerView` 时，针对非预言家玩家对 `gameLog` 进行脱敏：移除 `details.checkResults`；预言家保留完整 `gameLog`。
  - 狼人队友可见：已实现（289-293）。保持。

- SocketHandlersEnhanced（`src/server/SocketHandlersEnhanced.ts`）
  - 夜聊/公聊：保持现有夜聊仅狼可见（224-249）。
  - 夜间行动：继续由服务端校验 `socket.id` → `player.id`（166-191）。

## 客户端改动
- 阶段显示与冲突修复
  - PhaseIndicator（`src/components/werewolf/PhaseIndicator.tsx`）：
    - 将 `PHASE_CONFIG` 中的 `DAY_RESULT` 替换/扩展为 `DAY_MORNING_RESULT`；新增 `DAY_DEATH_LAST_WORDS` 标签与图标。
    - 确保计时与回合号显示基于服务端 `room_state.timer/currentRound`。

- 预言家查验身份卡（Seer）
  - MultiplayerGameRoom（`src/pages/werewolf/MultiplayerGameRoom.tsx`）：
    - 从 `roomState.gameLog` 过滤事件 `Night actions resolved`（592）并读取 `details.checkResults`，映射为 `seerCheckHistory`：
      - `targetId`、`targetName`、`isWerewolf`、`round`。
    - 将 `seerCheckHistory` 传给 `RoundTableView`（574-589 调用处）。
    - 监听 `seer_check_result` 私聊事件（在 `useGameSocket` 中新增监听），对人类预言家即时弹出 `SeerCheckCard`。
  - RoundTableView（`src/components/werewolf/RoundTableView.tsx`）：已支持 `seerCheckHistory`（63-86、176-185），无需结构性改动。

- 狼人夜间行动与默认行为
  - NightActionPanel（`src/components/werewolf/NightActionPanel.tsx`）：保留角色面板；无提交目标时按钮置灰（151-156）。
  - 如狼未在时限内提交，服务端进行默认击杀（上节服务端改动）。

## 规则与状态机保证
- 夜晚顺序：
  - 狼人击杀（合并投票）→ 守卫保护 → 女巫解药 → 奶穿判定 → 女巫毒药（强制死亡）→ 更新死亡名单 → 猎人/警徽特殊阶段判定。
- 私有记忆流：仅注入至预言家（AI）；人类预言家仅通过私聊事件接收。
- 讨论顺序：按 `position` 或 `sheriff` 调整起手位（198-215）；超时自动换人（257-267）。
- 投票平票：无淘汰（638-676），写入日志。

## 测试与验证
- 单房间端到端：
  - 创建房间 → AI补位 → 开局 → 夜晚：
    - 两个狼人提交同一目标 → 预言家查验 → 女巫救/毒 → 早晨广播死亡或平安夜。
    - 验证：预言家在其客户端上弹出 `SeerCheckCard`；其他玩家看不到查验结果。
  - 白天讨论：阶段、计时与发言顺序正确；机器人自动发言。
  - 白天投票：正确统计票型与平票处理，必要时进入遗言或特殊阶段。
- 跨浏览器来源：`localhost` 与 `127.0.0.1` 均能连接；CORS 白名单已包含两者（服务端）。

## 交付内容
- 服务端：`GameStateMachine.ts`（私聊查验+默认击杀+AI记忆注入）、`RoomManager.ts`（日志脱敏）。
- 客户端：`PhaseIndicator.tsx`（阶段映射）、`useGameSocket.ts`（监听 `seer_check_result`）、`MultiplayerGameRoom.tsx`（派生并传递 `seerCheckHistory`）。

请确认上述方案，我将按此实施并提交具体代码改动。