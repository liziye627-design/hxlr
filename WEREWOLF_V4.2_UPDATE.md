# 狼人杀游戏 V4.2 更新说明

## 🎯 本次更新目标

1. 修复角色分配失败问题（字段名不匹配）
2. 为狼人玩家显示队友信息
3. 确保每个AI玩家都有明确的角色分配

## ✅ 已修复的问题

### 问题1：角色分配失败

**问题描述**：
- 角色卡片一直显示"正在分配角色..."
- 无法看到具体的角色信息
- 控制台显示角色数组为空

**根本原因**：
- 数据库配置使用`werewolf_count`、`villager_count`等字段名
- 代码中使用`werewolf`、`villager`等字段名
- 字段名不匹配导致读取失败

**解决方案**：
```typescript
// 修改前
const werewolfCount = roleConfig.werewolf || 0;

// 修改后（兼容两种字段名）
const werewolfCount = roleConfig.werewolf_count || roleConfig.werewolf || 0;
```

**修复结果**：
- ✅ 角色分配成功
- ✅ 角色卡片正常显示
- ✅ 所有玩家都有明确的角色

### 问题2：狼人看不到队友

**问题描述**：
- 狼人玩家无法知道谁是自己的队友
- 不符合狼人杀游戏规则

**解决方案**：
在角色卡片中添加狼人队友信息区域：

```typescript
{/* 狼人队友信息 */}
{userRole === 'werewolf' && (
  <div className="w-full space-y-3 p-4 bg-destructive/10 rounded-lg border-2 border-destructive/30">
    <h4 className="text-center font-bold text-destructive flex items-center justify-center gap-2">
      <Users className="w-5 h-5" />
      你的狼人队友
    </h4>
    <div className="space-y-2">
      {players
        .filter(p => p.role === 'werewolf' && p.id !== 'user')
        .map(teammate => (
          <div key={teammate.id} className="flex items-center gap-2 p-2 bg-background rounded">
            <span className="text-2xl">🐺</span>
            <div className="flex-1">
              <p className="font-medium">[{teammate.position}号] {teammate.name}</p>
              {teammate.persona && (
                <p className="text-xs text-muted-foreground">{teammate.persona.description}</p>
              )}
            </div>
          </div>
        ))}
    </div>
  </div>
)}
```

**修复结果**：
- ✅ 狼人玩家可以看到所有队友
- ✅ 显示队友的座位号和名称
- ✅ 显示队友的人设描述

### 问题3：AI玩家角色不明确

**问题描述**：
- 不确定AI玩家是否有角色分配

**确认结果**：
- ✅ AI玩家已经有角色分配
- ✅ 通过`assignedRoles[index + 1]`分配
- ✅ 添加了调试日志输出所有玩家角色

## 🎨 新增功能

### 1. 狼人队友显示

**界面设计**：
```
┌─────────────────────────────────┐
│          你的身份               │
│   请记住你的角色，不要告诉其他人 │
├─────────────────────────────────┤
│                                 │
│           🐺                    │
│          狼人                   │
│                                 │
│  你是狼人阵营，夜晚可以与其他   │
│      狼人商议击杀目标           │
│                                 │
│      🐺 狼人阵营                │
├─────────────────────────────────┤
│      👥 你的狼人队友            │
├─────────────────────────────────┤
│  🐺 [3号] 激进派                │
│     发言激进，主动带节奏        │
├─────────────────────────────────┤
│  [我知道了，开始游戏]           │
└─────────────────────────────────┘
```

**特点**：
- 红色边框突出显示
- 显示队友座位号
- 显示队友名称
- 显示队友人设描述
- 如果是唯一狼人，显示提示信息

### 2. 角色分配验证

**功能**：
```typescript
// 验证角色数量
if (roles.length !== playerCount) {
  console.error(`错误：角色数量(${roles.length})不等于玩家数量(${playerCount})`);
  toast({
    title: '角色配置错误',
    description: `角色数量(${roles.length})不等于玩家数量(${playerCount})`,
    variant: 'destructive',
  });
  // 自动补充平民
  while (roles.length < playerCount) {
    roles.push('villager');
  }
}
```

**特点**：
- 自动检测角色数量是否正确
- 如果不足，自动补充平民
- 显示错误提示
- 确保游戏能正常进行

### 3. 调试日志增强

**新增日志**：
```
=== 所有玩家角色分配 ===
[1号] 你: 狼人 (werewolf)
[2号] 逻辑大师: 预言家 (seer)
[3号] 情感玩家: 狼人 (werewolf)
[4号] 激进派: 女巫 (witch)
[5号] 谨慎派: 平民 (villager)
[6号] 新手友好: 平民 (villager)
```

**用途**：
- 方便调试和验证
- 快速查看所有玩家角色
- 确认角色分配是否正确

## 📋 代码变更

### 文件：src/pages/werewolf/GameRoom.tsx

#### 变更1：修复角色分配逻辑

**位置**：第100-166行

**修改内容**：
- 兼容两种字段名（`werewolf_count`和`werewolf`）
- 添加角色数量验证
- 自动补充平民到正确数量

#### 变更2：添加狼人队友显示

**位置**：第973-999行

**修改内容**：
- 添加狼人队友信息区域
- 过滤出其他狼人玩家
- 显示队友详细信息

#### 变更3：添加调试日志

**位置**：第239-243行

**修改内容**：
- 输出所有玩家的角色分配
- 包含座位号、名称和角色

## 🧪 测试验证

### 测试场景1：6人局（2狼人）

**步骤**：
1. 选择6人局
2. 选择5个AI人设
3. 开始游戏

**预期结果**：
- 如果用户是狼人：
  - ✅ 显示1个狼人队友
  - ✅ 显示队友座位号和名称
- 如果用户不是狼人：
  - ✅ 不显示队友信息
  - ✅ 正常显示角色卡片

### 测试场景2：9人局（3狼人）

**步骤**：
1. 选择9人局
2. 选择8个AI人设
3. 开始游戏

**预期结果**：
- 如果用户是狼人：
  - ✅ 显示2个狼人队友
  - ✅ 队友信息完整

### 测试场景3：12人局（4狼人）

**步骤**：
1. 选择12人局
2. 选择11个AI人设
3. 开始游戏

**预期结果**：
- 如果用户是狼人：
  - ✅ 显示3个狼人队友
  - ✅ 队友信息完整

### 控制台日志验证

**预期日志**：
```
=== 开始分配角色 ===
玩家数量: 6
角色配置: {werewolf_count: 2, villager_count: 2, seer_count: 1, witch_count: 1}
分配的角色数组: ["werewolf", "werewolf", "villager", "villager", "seer", "witch"]
角色数量: 6
打乱后的角色: ["werewolf", "seer", "villager", "witch", "werewolf", "villager"]

=== 用户角色分配 ===
用户角色: werewolf
用户角色类型: string
是否为undefined: false
是否为null: false
已调用setUserRole，等待状态更新...

=== 所有玩家角色分配 ===
[1号] 你: 狼人 (werewolf)
[2号] 逻辑大师: 预言家 (seer)
[3号] 情感玩家: 平民 (villager)
[4号] 激进派: 女巫 (witch)
[5号] 谨慎派: 狼人 (werewolf)
[6号] 新手友好: 平民 (villager)

角色分配完成，等待显示角色卡片

检测到角色已分配: werewolf
显示角色卡片
```

## 🎮 游戏规则说明

### 狼人阵营

**角色**：狼人  
**人数**：
- 6人局：2人
- 9人局：3人
- 12人局：4人

**特殊能力**：
- ✅ 知道所有狼人队友的身份
- ✅ 夜晚可以选择击杀目标
- ✅ 可以与队友配合行动

**胜利条件**：
- 狼人数量 ≥ 好人数量

### 好人阵营

**角色**：预言家、女巫、猎人、守卫、平民

**特点**：
- ❌ 不知道其他好人的身份
- ✅ 通过发言和投票找出狼人
- ✅ 各有特殊技能（除平民外）

**胜利条件**：
- 所有狼人出局

## 📊 角色配置

### 6人局
| 角色 | 数量 | 阵营 |
|------|------|------|
| 狼人 | 2 | 狼人 |
| 预言家 | 1 | 好人 |
| 女巫 | 1 | 好人 |
| 平民 | 2 | 好人 |

### 9人局
| 角色 | 数量 | 阵营 |
|------|------|------|
| 狼人 | 3 | 狼人 |
| 预言家 | 1 | 好人 |
| 女巫 | 1 | 好人 |
| 猎人 | 1 | 好人 |
| 平民 | 3 | 好人 |

### 12人局
| 角色 | 数量 | 阵营 |
|------|------|------|
| 狼人 | 4 | 狼人 |
| 预言家 | 1 | 好人 |
| 女巫 | 1 | 好人 |
| 猎人 | 1 | 好人 |
| 守卫 | 1 | 好人 |
| 平民 | 4 | 好人 |

## 🔍 调试指南

### 如何验证角色分配

1. **打开控制台**（F12）

2. **查看日志**
   ```
   === 所有玩家角色分配 ===
   ```

3. **验证数量**
   - 狼人数量是否正确
   - 特殊角色是否存在
   - 总人数是否匹配

### 如何验证狼人队友显示

1. **多次开始游戏**
   - 直到分配到狼人角色

2. **检查角色卡片**
   - 是否显示"你的狼人队友"区域
   - 队友数量是否正确
   - 队友信息是否完整

3. **验证队友身份**
   - 对照控制台日志
   - 确认显示的队友确实是狼人

## 💡 使用建议

### 对于狼人玩家

1. **记住队友**
   - 仔细查看队友的座位号
   - 记住队友的名称和人设

2. **配合行动**
   - 白天发言时保护队友
   - 夜晚商议击杀目标

3. **隐藏身份**
   - 不要暴露队友身份
   - 伪装成好人

### 对于好人玩家

1. **仔细观察**
   - 注意发言矛盾
   - 分析投票行为

2. **使用技能**
   - 预言家查验可疑玩家
   - 女巫合理使用药水
   - 守卫保护关键角色

3. **团队合作**
   - 相信队友
   - 共同找出狼人

## 🎉 总结

### 本次更新解决的问题

1. ✅ 角色分配失败（字段名不匹配）
2. ✅ 狼人看不到队友
3. ✅ AI玩家角色不明确

### 新增功能

1. ✅ 狼人队友信息显示
2. ✅ 角色数量自动验证
3. ✅ 调试日志增强

### 改进效果

- 游戏规则更完整
- 用户体验更好
- 调试更方便
- 代码更健壮

---

**更新时间**: 2025-01-10  
**版本**: V4.2  
**状态**: ✅ 已发布  
**修复内容**: 角色分配失败 + 狼人队友显示
