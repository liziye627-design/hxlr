# 狼人杀游戏V3.0 - 完整游戏系统实现计划

## 项目概述

将狼人杀游戏升级为完整的多人在线游戏系统，支持真人+AI混合对战、语音交互、完整游戏逻辑。

## 核心新功能

### 1. AI模型配置系统 ✅
- [ ] 创建AI模型配置表（ai_model_configs）
- [ ] 支持多种AI提供商（DeepSeek、OpenAI、Claude等）
- [ ] 用户可配置API密钥
- [ ] 每个人设可选择AI模型
- [ ] AI模型管理界面

### 2. 用户认证系统 ✅
- [ ] 集成Supabase Auth
- [ ] 用户注册/登录页面
- [ ] 用户个人资料
- [ ] 游戏历史记录

### 3. 房间系统 ✅
- [ ] 创建游戏房间表（game_rooms）
- [ ] 房间创建界面
- [ ] 房间列表和搜索
- [ ] 房间配置：
  - [ ] 总人数（6/9/12人）
  - [ ] 真人数量
  - [ ] AI数量
  - [ ] 角色配置
- [ ] 房间状态管理（等待/进行中/已结束）
- [ ] 玩家加入/退出房间

### 4. 角色分配系统 ✅
- [ ] 随机角色分配算法
- [ ] 角色卡片展示
- [ ] 角色图片资源：
  - [ ] 狼人图片
  - [ ] 预言家图片
  - [ ] 女巫图片
  - [ ] 守卫图片
  - [ ] 平民图片
- [ ] 身份隐藏机制
- [ ] 只向玩家展示自己的身份

### 5. 完整游戏逻辑 ✅

#### 5.1 游戏状态机
- [ ] 初始化阶段
- [ ] 夜晚阶段
- [ ] 白天阶段
- [ ] 投票阶段
- [ ] 结算阶段
- [ ] 游戏结束

#### 5.2 夜晚阶段逻辑
- [ ] 守卫行动
  - [ ] 守卫选择守护目标
  - [ ] 记录守护状态
- [ ] 狼人行动
  - [ ] 狼人之间可以交流
  - [ ] 狼人投票选择击杀目标
  - [ ] 记录击杀目标
- [ ] 女巫行动
  - [ ] 显示死亡信息
  - [ ] 选择使用解药/毒药
  - [ ] 记录用药状态
- [ ] 预言家行动
  - [ ] 选择验人目标
  - [ ] 返回阵营信息

#### 5.3 结算逻辑
- [ ] 同守同救判定（奶穿肠）
- [ ] 死亡结算
- [ ] 猎人技能触发判定
- [ ] 公布死亡信息

#### 5.4 白天阶段逻辑
- [ ] 公布昨夜死亡名单
- [ ] 警长竞选（第一天）
  - [ ] 上警
  - [ ] 警长发言
  - [ ] 警长投票
  - [ ] 警徽移交
- [ ] 轮流发言
  - [ ] 发言顺序管理
  - [ ] 发言计时
- [ ] 放逐投票
  - [ ] 投票界面
  - [ ] 警长1.5票权重
  - [ ] 平票PK
  - [ ] 再次投票
- [ ] 遗言

#### 5.5 胜利条件判定
- [ ] 狼人胜利：平民全灭或神职全灭
- [ ] 好人胜利：狼人全灭
- [ ] 实时检查胜利条件

### 6. 语音交互系统 ✅
- [ ] STT（语音转文字）集成
  - [ ] 选择STT服务提供商
  - [ ] 录音功能
  - [ ] 实时转写
- [ ] TTS（文字转语音）集成
  - [ ] 选择TTS服务提供商
  - [ ] AI语音播报
  - [ ] 系统提示语音
- [ ] 语音控制界面
  - [ ] 录音按钮
  - [ ] 播放控制
  - [ ] 音量控制

### 7. AI行为系统 ✅
- [ ] AI提示词模板
  - [ ] 基础角色提示词
  - [ ] 人设特征融合
  - [ ] 身份隐藏指令
- [ ] AI决策系统
  - [ ] 夜晚行动决策
  - [ ] 白天发言生成
  - [ ] 投票决策
- [ ] AI策略优化
  - [ ] 根据游戏状态调整策略
  - [ ] 避免暴露身份

### 8. 实时通信系统 ✅
- [ ] WebSocket集成（Supabase Realtime）
- [ ] 实时消息同步
- [ ] 游戏状态同步
- [ ] 玩家行动同步

### 9. 数据库架构更新 ✅

#### 新增表
- [ ] `ai_model_configs` - AI模型配置
- [ ] `game_rooms` - 游戏房间
- [ ] `room_players` - 房间玩家
- [ ] `game_states` - 游戏状态
- [ ] `night_actions` - 夜晚行动记录
- [ ] `vote_records` - 投票记录
- [ ] `game_logs` - 游戏日志

#### 更新表
- [ ] 更新 `werewolf_personas` 添加AI模型关联
- [ ] 更新 `game_sessions` 添加房间关联

### 10. UI/UX重构 ✅

#### 新增页面
- [ ] 登录/注册页面
- [ ] 房间大厅页面
- [ ] 房间创建页面
- [ ] 房间详情页面
- [ ] 角色展示页面
- [ ] 游戏主界面（重构）
  - [ ] 玩家列表（显示存活状态）
  - [ ] 角色卡片
  - [ ] 行动面板（根据角色和阶段显示）
  - [ ] 聊天区域
  - [ ] 投票界面
  - [ ] 语音控制

#### UI组件
- [ ] 角色卡片组件
- [ ] 玩家头像组件
- [ ] 投票组件
- [ ] 语音录音组件
- [ ] 游戏日志组件
- [ ] 倒计时组件

### 11. 游戏配置管理 ✅
- [ ] AI模型配置界面
- [ ] 游戏规则配置
- [ ] 角色技能说明
- [ ] 游戏教程

## 实现优先级

### Phase 1: 基础架构（第1-2周）
1. ✅ 数据库架构设计和迁移
2. ✅ 用户认证系统
3. ✅ 房间系统基础功能
4. ✅ AI模型配置系统

### Phase 2: 核心游戏逻辑（第3-4周）
1. ✅ 角色分配系统
2. ✅ 游戏状态机
3. ✅ 夜晚阶段逻辑
4. ✅ 白天阶段逻辑
5. ✅ 投票系统
6. ✅ 胜利条件判定

### Phase 3: AI和语音（第5-6周）
1. ✅ AI决策系统
2. ✅ AI提示词优化
3. ✅ STT集成
4. ✅ TTS集成
5. ✅ 语音UI

### Phase 4: 实时通信和优化（第7-8周）
1. ✅ WebSocket集成
2. ✅ 实时状态同步
3. ✅ 性能优化
4. ✅ UI/UX优化
5. ✅ 测试和调试

## 技术栈

### 前端
- React + TypeScript
- shadcn/ui
- Tailwind CSS
- WebSocket/Supabase Realtime
- Web Audio API（语音录音）

### 后端
- Supabase
  - Database（PostgreSQL）
  - Auth
  - Realtime
  - Edge Functions

### AI服务
- DeepSeek API
- OpenAI API（可选）
- Claude API（可选）

### 语音服务
- 百度语音识别（STT）
- 百度语音合成（TTS）
- 或其他语音服务提供商

## 风险和挑战

### 技术风险
1. **实时同步复杂度**：多人游戏状态同步可能出现延迟和冲突
2. **语音处理延迟**：STT/TTS可能有延迟，影响游戏体验
3. **AI决策质量**：AI可能做出不合理的决策或暴露身份
4. **并发处理**：多个玩家同时行动时的并发控制

### 解决方案
1. 使用Supabase Realtime确保状态同步
2. 优化语音处理流程，提供文字备选
3. 精心设计AI提示词，加入游戏规则约束
4. 使用数据库事务和锁机制处理并发

## 测试计划

### 单元测试
- [ ] 角色分配算法测试
- [ ] 游戏逻辑测试
- [ ] AI决策测试

### 集成测试
- [ ] 完整游戏流程测试
- [ ] 多人同时游戏测试
- [ ] 语音功能测试

### 压力测试
- [ ] 并发房间测试
- [ ] 大量玩家测试

## 文档

- [ ] API文档
- [ ] 游戏规则文档
- [ ] 用户使用手册
- [ ] 开发者文档

## 当前状态

- **开始时间**: 2025-01-10
- **当前阶段**: 规划阶段
- **预计完成**: 2025-03-10（8周）

---

**注意**: 这是一个大型项目，需要分阶段实现。建议先完成Phase 1和Phase 2，确保核心游戏逻辑正确，再添加语音和高级功能。
